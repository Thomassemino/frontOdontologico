const l="https://consultorio-odontologico-backend-production-b1c8.up.railway.app/api/";let a={id:new URLSearchParams(window.location.search).get("id"),paso1:{},paso2:{},paso3:{}};async function m(){try{const o=new URLSearchParams(window.location.search),t=o.get("id"),i=o.get("motivo");if(!t)throw new Error("No se proporcionó ID de cita");const n=await fetch(`${l}/citas/${t}`);if(!n.ok)throw new Error("Error al cargar datos de la cita");const r=await n.json();console.log("Datos de la cita cargados:",r);const e=i||r.motivo||"",d=document.getElementById("motivoConsulta");d&&(d.value=e,console.log(e),a.motivoOriginal=e),a.citaInfo={...r,motivo:e},console.log("Datos finales cargados:",{motivoOriginal:a.motivoOriginal,citaInfo:a.citaInfo})}catch(o){console.error("Error al cargar datos de la cita:",o),alert("Error al cargar los datos de la consulta")}}function s(o){document.querySelectorAll("form").forEach(i=>i.classList.add("hidden")),document.getElementById(`paso${o}`)?.classList.remove("hidden"),document.querySelectorAll(".paso-btn").forEach(i=>{i.classList.remove("text-blue-600","dark:text-blue-400","border-b-2","border-blue-600","dark:border-blue-400"),i.classList.add("text-gray-400")});const t=document.getElementById(`paso${o}Btn`);t&&(t.classList.remove("text-gray-400"),t.classList.add("text-blue-600","dark:text-blue-400","border-b-2","border-blue-600","dark:border-blue-400"))}function c(o){const t=document.getElementById(`paso${o}`);if(!t)return;const i=new FormData(t),n={};i.forEach((r,e)=>{e.endsWith("[]")?(n[e]||(n[e]=[]),n[e].push(r)):e==="fuma"||e==="diabetes"||e==="embarazada"||e==="dificultadMasticar"||e==="dificultadAbrirBoca"||e==="sangradoEncias"||e==="hinchazanCara"?n[e]=r==="on":n[e]=r}),a[`paso${o}`]=n}async function u(o){o&&o.preventDefault(),c(1),c(2),c(3);try{const t=a.citaInfo.pacienteId.id||a.citaInfo.pacienteId,i={datosPersonalesMedicos:{enfermedades:a.paso1.enfermedades||"",tratamientoActual:a.paso1.tratamientoMedico||"",medicamentosRegulares:a.paso1.medicamentos||"",enfermedadInfectoInfecciosa:a.paso1.enfermedadInfectoInfecciosa||"",fuma:!!a.paso1.fuma,embarazo:!!a.paso1.embarazada,enfermedadConstancia:a.paso1.otrasEnfermedades||"",alergias:a.paso1.alergias||"",diabetes:!!a.paso1.diabetes,enfermedadTransmisionSexual:a.paso1.enfermedadTransmisionSexual||"",motivoConsulta:a.motivoOriginal||a.citaInfo.motivo||""},antecedentesMedicosOdontologicos:{consultoOdontologo:a.paso2.consultaPrevia==="si",tratamientoOdontologico:{descripcion:a.paso2.tratamientoOdontologico||"",desdeCuando:new Date().toISOString()},dolor:JSON.stringify({rango:a.paso2.rangoDolor||"",tipo:a.paso2.tipoDolor||"",caracteristicas:a.paso2["caracteristicasDolor[]"]||[],sensibilidad:a.paso2["sensibilidad[]"]||[],localizacion:a.paso2.localizacionDolor||""}),fracturaDiente:a.paso2.fracturas||"",dificultadMasticar:!!a.paso2.dificultadMasticar,dificultadAbrirBoca:!!a.paso2.dificultadAbrirBoca},estadoActual:{anormalidadBoca:a.paso3.anormalidadBucal||"",sangradoEncias:!!a.paso3.sangradoEncias,hinchazonCara:!!a.paso3.hinchazanCara,higieneBucal:(a.paso3.higieneBucal||"bueno").toLowerCase()},aclaracionesFinalesMedico:a.paso3.anotacionesMedico||"",pacienteId:t};console.log("Datos a enviar:",i);const n=await fetch(`${l}/historiaClinica/create`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!n.ok){const d=await n.json();throw new Error(d.message||"Error al guardar la historia clínica")}const r={estado:"completada",fecha:a.citaInfo.fecha,motivo:a.motivoOriginal||a.citaInfo.motivo,medicoId:a.citaInfo.medicoId._id||a.citaInfo.medicoId,pacienteId:t,tratamientos:a.citaInfo.tratamientos};if(console.log("Actualizando cita con:",r),!(await fetch(`${l}/citas/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).ok)throw new Error("Error al actualizar el estado de la cita");alert("Consulta guardada exitosamente"),window.location.href="/"}catch(t){console.error("Error detallado:",t),alert("Error al guardar la consulta: "+t.message)}}document.getElementById("volverBtn")?.addEventListener("click",o=>{o.preventDefault(),window.location.href="/"});document.getElementById("cancelarBtn")?.addEventListener("click",o=>{o.preventDefault(),confirm("¿Está seguro que desea cancelar? Se perderán los cambios no guardados.")&&(window.location.href="/")});["paso1Btn","paso2Btn","paso3Btn"].forEach((o,t)=>{document.getElementById(o)?.addEventListener("click",()=>s(t+1))});document.getElementById("siguiente1")?.addEventListener("click",()=>{c(1),s(2)});document.getElementById("anterior2")?.addEventListener("click",()=>s(1));document.getElementById("siguiente2")?.addEventListener("click",()=>{c(2),s(3)});document.getElementById("anterior3")?.addEventListener("click",()=>s(2));document.getElementById("guardar")?.addEventListener("click",o=>u(o));document.addEventListener("DOMContentLoaded",()=>{m()});s(1);
